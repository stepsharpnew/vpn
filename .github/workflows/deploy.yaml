name: CI/CD for vpn_api

on:
  push:
    branches:
      - main
    paths:
      - 'backend/**'
  pull_request:
    branches:
      - main
    paths:
      - 'backend/**'

jobs:
  version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      version-type: ${{ steps.version.outputs.version-type }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine version type from branch name
        id: version
        run: |
          # –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–µ—Ç–∫–∏ (–¥–ª—è PR - –∏—Å—Ö–æ–¥–Ω–∞—è –≤–µ—Ç–∫–∞, –¥–ª—è push - —Ç–µ–∫—É—â–∞—è –≤–µ—Ç–∫–∞)
          if [ -n "${{ github.head_ref }}" ]; then
            BRANCH_NAME="${{ github.head_ref }}"
          else
            BRANCH_NAME="${{ github.ref_name }}"
          fi
          echo "Branch name: $BRANCH_NAME"
          
          # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –≤–µ—Ä—Å–∏–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ –≤–µ—Ç–∫–∏
          # –ü–∞—Ç—Ç–µ—Ä–Ω—ã: major(major|breaking|!), minor(feat|feature|minor), patch(fix|patch|bug)
          # –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è –≤–∞—Ä–∏–∞–Ω—Ç—ã: "feature", "feat:", "feat/", "feat-", "feat ", "feature-something" –∏ —Ç.–¥.
          VERSION_TYPE="patch"  # –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é patch
          
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è major –≤–µ—Ä—Å–∏–∏: major, breaking, !
          # –ü–∞—Ç—Ç–µ—Ä–Ω: —Å–ª–æ–≤–æ –≤ –Ω–∞—á–∞–ª–µ –∏–ª–∏ –ø–æ—Å–ª–µ —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è, —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª–µ–º –ø–æ—Å–ª–µ –∏–ª–∏ –≤ –∫–æ–Ω—Ü–µ —Å—Ç—Ä–æ–∫–∏
          if echo "$BRANCH_NAME" | grep -qiE '(^|/|-|_|\s)(major|breaking|!)(:|/|-|\s|$)'; then
            VERSION_TYPE="major"
            echo "‚úì Detected MAJOR version bump (major/breaking/! in branch name)"
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è minor –≤–µ—Ä—Å–∏–∏: feat, feature, minor
          elif echo "$BRANCH_NAME" | grep -qiE '(^|/|-|_|\s)(feat|feature|minor)(:|/|-|\s|$)'; then
            VERSION_TYPE="minor"
            echo "‚úì Detected MINOR version bump (feat/feature/minor in branch name)"
          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è patch –≤–µ—Ä—Å–∏–∏: fix, patch, bug
          elif echo "$BRANCH_NAME" | grep -qiE '(^|/|-|_|\s)(fix|patch|bug)(:|/|-|\s|$)'; then
            VERSION_TYPE="patch"
            echo "‚úì Detected PATCH version bump (fix/patch/bug in branch name)"
          else
            echo "‚ö† No pattern matched in branch name, defaulting to PATCH version bump"
            echo "  Supported patterns:"
            echo "    - MAJOR: major, breaking, ! (e.g., 'major', 'major:', 'breaking-change', '!refactor')"
            echo "    - MINOR: feat, feature, minor (e.g., 'feature', 'feat:', 'minor-update')"
            echo "    - PATCH: fix, patch, bug (e.g., 'fix', 'fix:', 'bug-fix')"
          fi
          
          # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–π —Ç–µ–≥ (–µ—Å–ª–∏ –µ—Å—Ç—å)
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "Last tag: $LAST_TAG"
          
          # –£–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å 'v' –µ—Å–ª–∏ –µ—Å—Ç—å
          LAST_VERSION=${LAST_TAG#v}
          
          # –†–∞–∑–±–∏–≤–∞–µ–º –≤–µ—Ä—Å–∏—é –Ω–∞ —á–∞—Å—Ç–∏ (—Å –æ–±—Ä–∞–±–æ—Ç–∫–æ–π —Å–ª—É—á–∞—è, –∫–æ–≥–¥–∞ –≤–µ—Ä—Å–∏—è –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–ø–æ–ª–Ω–æ–π)
          IFS='.' read -r MAJOR MINOR PATCH <<< "$LAST_VERSION"
          MAJOR=${MAJOR:-0}
          MINOR=${MINOR:-0}
          PATCH=${PATCH:-0}
          
          # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –≤–µ—Ä—Å–∏—é –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
          case $VERSION_TYPE in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac
          
          # –§–æ—Ä–º–∏—Ä—É–µ–º –Ω–æ–≤—É—é –≤–µ—Ä—Å–∏—é
          NEW_VERSION="$MAJOR.$MINOR.$PATCH"
          echo "Version type: $VERSION_TYPE"
          echo "New version: $NEW_VERSION"
          
          echo "version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "version-type=$VERSION_TYPE" >> $GITHUB_OUTPUT

  build-and-deploy:
    runs-on: ubuntu-latest
    needs: version
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    permissions:
      contents: write
      pull-requests: read
    
    steps:
    # 1. Checkout –∫–æ–¥–∞ —Å –ø–æ–ª–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–µ–π –¥–ª—è —Ç–µ–≥–æ–≤
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
        ref: main

    # 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Git –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ç–µ–≥–æ–≤
    - name: Configure Git
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

    # 3. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–µ—Ä—Å–∏–π –≤ —Ñ–∞–π–ª–∞—Ö –ø—Ä–æ–µ–∫—Ç–∞
    - name: Update version in pyproject.toml
      run: |
        VERSION="${{ needs.version.outputs.version }}"
        sed -i "s/^version = \".*\"/version = \"$VERSION\"/" ./backend/pyproject.toml
        echo "Updated backend version to $VERSION"

    - name: Update version in pubspec.yaml
      run: |
        VERSION="${{ needs.version.outputs.version }}"
        # –û–±–Ω–æ–≤–ª—è–µ–º –≤–µ—Ä—Å–∏—é –≤ —Ñ–æ—Ä–º–∞—Ç–µ X.Y.Z+BUILD
        BUILD_NUMBER=$(echo "$VERSION" | cut -d'.' -f3)
        sed -i "s/^version: .*/version: $VERSION+$BUILD_NUMBER/" ./test_app/pubspec.yaml
        echo "Updated frontend version to $VERSION+$BUILD_NUMBER"

    # 4. –°–æ–∑–¥–∞–Ω–∏–µ git tag –∏ –∫–æ–º–º–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤–µ—Ä—Å–∏–π
    - name: Create version tag and commit
      run: |
        VERSION="${{ needs.version.outputs.version }}"
        TAG="v$VERSION"
        
        echo "Creating tag: $TAG"
        
        # –ü–æ–ª—É—á–∞–µ–º –ø–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
        git fetch origin main || true
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ç–µ–≥ –Ω–∞ —É–¥–∞–ª–µ–Ω–Ω–æ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
        if git ls-remote --tags origin "$TAG" | grep -q "$TAG"; then
          echo "‚ö† Tag $TAG already exists on remote, skipping tag creation"
        else
          # –ö–æ–º–º–∏—Ç–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤–µ—Ä—Å–∏–π (–µ—Å–ª–∏ –µ—Å—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è)
          git add ./backend/pyproject.toml ./test_app/pubspec.yaml || true
          
          if git diff --staged --quiet; then
            echo "‚Ñπ No version changes to commit (versions may already be up to date)"
          else
            echo "üìù Committing version changes..."
            git commit -m "chore: bump version to $TAG"
            git push origin main
            echo "‚úì Version changes committed and pushed"
          fi
          
          # –°–æ–∑–¥–∞–µ–º —Ç–µ–≥ –Ω–∞ —Ç–µ–∫—É—â–µ–º –∫–æ–º–º–∏—Ç–µ (–µ—Å–ª–∏ —Ç–µ–≥ –µ—â–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–æ–∫–∞–ª—å–Ω–æ)
          if git rev-parse "$TAG" >/dev/null 2>&1; then
            echo "‚ö† Tag $TAG already exists locally, deleting and recreating..."
            git tag -d "$TAG" || true
          fi
          
          echo "üè∑ Creating tag $TAG..."
          git tag -a "$TAG" -m "Release $TAG"
          
          # –ü—É—à–∏–º —Ç–µ–≥
          echo "üì§ Pushing tag $TAG..."
          git push origin "$TAG" || {
            echo "‚ùå Failed to push tag, trying force push..."
            git push origin "$TAG" --force || true
          }
          echo "‚úÖ Tag $TAG created and pushed successfully"
        fi

    # 5. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ SSH
    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.9.0
      with:
        ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}
    
    # 6. –£—Å—Ç–∞–Ω–æ–≤–∏–º docker-compose
    - name: Install Docker Compose
      run: |
        sudo apt-get update
        sudo apt-get install -y docker-compose
    
    # 7. –°–æ–∑–¥–∞—ë–º —Ñ–∞–π–ª .env-non-dev –∏–∑ —Å–µ–∫—Ä–µ—Ç–æ–≤
    - name: Create .env-non-dev file
      run: echo "${{ secrets.ENV_NON_DEV }}" > ./backend/.env-non-dev

    # 8. –ü—Ä–æ–≤–µ—Ä–∫–∞ Docker Compose
    - name: Lint Docker Compose
      run: |
        cd ./backend
        echo "Validating docker-compose.yaml..."
        docker-compose config
        echo "‚úì Docker Compose configuration is valid"

    # 9. –°–±–æ—Ä–∫–∞ Docker –æ–±—Ä–∞–∑–æ–≤ —Å –≤–µ—Ä—Å–∏–µ–π
    - name: Build Docker images
      run: |
        set -e
        VERSION="${{ needs.version.outputs.version }}"
        cd ./backend
        
        echo "üî® Building Docker images..."
        echo "Working directory: $(pwd)"
        echo "Docker Compose file: $(ls -la docker-compose.yaml)"
        
        # –°–æ–±–∏—Ä–∞–µ–º –æ–±—Ä–∞–∑—ã
        docker-compose build --no-cache
        
        echo "‚úì Docker images built successfully"
        
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–∑–¥–∞–Ω–Ω—ã–µ –æ–±—Ä–∞–∑—ã
        echo "üì¶ Built images:"
        docker images | grep -E "(vpn_api|REPOSITORY)" || docker images
        
        # –¢–µ–≥–∏—Ä—É–µ–º –æ–±—Ä–∞–∑—ã –≤–µ—Ä—Å–∏–µ–π (–µ—Å–ª–∏ –æ–±—Ä–∞–∑ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç)
        if docker images --format "{{.Repository}}" | grep -q "vpn_api_backend"; then
          docker tag vpn_api_backend:latest vpn_api_backend:$VERSION || true
          echo "‚úì Tagged image with version $VERSION"
        else
          echo "‚ö† Warning: vpn_api_backend image not found after build"
          echo "Available images:"
          docker images
        fi

    # 10. –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–æ–≤ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
    - name: Deploy files to server
      run: |
        ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USERNAME }}@${{ secrets.SERVER_IP_ADDRESS }} "mkdir -p ~/vpn_api"
        rsync -avz --exclude=".git" ./backend ${{ secrets.SERVER_USERNAME }}@${{ secrets.SERVER_IP_ADDRESS }}:~/vpn_api

    # 11. –ó–∞–ø—É—Å–∫ Docker Compose –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
    - name: Restart application
      run: |
        VERSION="${{ needs.version.outputs.version }}"
        ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USERNAME }}@${{ secrets.SERVER_IP_ADDRESS }} << EOF
          cd ~/vpn_api
          sudo docker-compose down
          sudo docker-compose build
          sudo docker-compose up -d
          echo "Deployed version $VERSION"
        EOF

  test:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'

    - name: Install dependencies
      run: |
        cd backend
        pip install uv
        uv sync

    - name: Run tests
      run: |
        cd backend
        # –î–æ–±–∞–≤—å—Ç–µ –∑–¥–µ—Å—å –∫–æ–º–∞–Ω–¥—ã –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ç–µ—Å—Ç–æ–≤
        echo "Tests would run here"